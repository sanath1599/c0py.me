name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    name: Deploy Backend Service
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Deploy to backend.c0py.me
      run: |
        # Create JSON payload with proper escaping
        COMMIT_MESSAGE=$(echo '${{ github.event.head_commit.message }}' | jq -Rs .)
        
        # Trigger webhook for backend deployment
        curl -X POST \
          -H "Content-Type: application/json" \
          -H "X-GitHub-Event: push" \
          -H "X-GitHub-Delivery: ${{ github.run_id }}" \
          -H "User-Agent: GitHub-Hookshot/$(openssl rand -hex 8)" \
          -d "{
            \"ref\": \"refs/heads/main\",
            \"repository\": {
              \"name\": \"sharedrop\",
              \"full_name\": \"${{ github.repository }}\",
              \"clone_url\": \"${{ github.server_url }}/${{ github.repository }}.git\"
            },
            \"commits\": [{
              \"id\": \"${{ github.sha }}\",
              \"message\": $COMMIT_MESSAGE,
              \"author\": {
                \"name\": \"${{ github.actor }}\"
              }
            }],
            \"head_commit\": {
              \"id\": \"${{ github.sha }}\",
              \"message\": $COMMIT_MESSAGE,
              \"author\": {
                \"name\": \"${{ github.actor }}\"
              }
            }
          }" \
          https://backend.c0py.me/webhook/deploy
          
    - name: Wait for deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 30
        
    - name: Health check
      run: |
        # Wait for service to be ready
        for i in {1..10}; do
          if curl -f https://backend.c0py.me/api/health; then
            echo "‚úÖ Backend service is healthy"
            break
          else
            echo "‚è≥ Waiting for service to be ready... (attempt $i/10)"
            sleep 10
          fi
        done
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üéâ Deployment completed successfully!"
        else
          echo "‚ùå Deployment failed!"
          exit 1
        fi 